"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const electron_1 = require("electron");
const fileUriToPath = require("file-uri-to-path");
const util_1 = require("../util");
const util_2 = require("./util");
class WebviewHandler {
    constructor(init) {
        this.emitter = new atom_1.Emitter();
        this.disposables = new atom_1.CompositeDisposable();
        this.destroyed = false;
        this.zoomLevel = 0;
        this.replyCallbacks = new Map();
        this.replyCallbackId = 0;
        this._element = document.createElement('webview');
        this._element.classList.add('markdown-preview-plus', 'native-key-bindings');
        this._element.disablewebsecurity = 'true';
        this._element.nodeintegration = 'true';
        this._element.src = `file:///${__dirname}/../../client/template.html`;
        this._element.style.width = '100%';
        this._element.style.height = '100%';
        this._element.addEventListener('ipc-message', (e) => {
            switch (e.channel) {
                case 'zoom-in':
                    this.zoomIn();
                    break;
                case 'zoom-out':
                    this.zoomOut();
                    break;
                case 'did-scroll-preview':
                    this.emitter.emit('did-scroll-preview', e.args[0]);
                    break;
                case 'uncaught-error': {
                    const err = e.args[0];
                    const newErr = new Error();
                    atom.notifications.addFatalError(`Uncaught error ${err.name} in markdown-preview-plus webview client`, {
                        dismissable: true,
                        stack: newErr.stack,
                        detail: `${err.message}\n\nstack:\n${err.stack}`,
                    });
                    break;
                }
                case 'show-context-menu': {
                    atom.contextMenu.showForEvent({ target: this._element });
                    break;
                }
                case 'request-reply': {
                    const { id, request, result } = e.args[0];
                    const cb = this.replyCallbacks.get(id);
                    if (cb && request === cb.request) {
                        const callback = cb.callback;
                        callback(result);
                    }
                    break;
                }
            }
        });
        this._element.addEventListener('will-navigate', async (e) => {
            const exts = util_1.atomConfig().previewConfig.shellOpenFileExtensions;
            const forceOpenExternal = exts.some((ext) => e.url.toLowerCase().endsWith(`.${ext.toLowerCase()}`));
            if (e.url.startsWith('file://') && !forceOpenExternal) {
                util_1.handlePromise(atom.workspace.open(fileUriToPath(e.url)));
            }
            else {
                electron_1.shell.openExternal(e.url);
            }
        });
        this.disposables.add(atom.styles.onDidAddStyleElement(() => {
            util_1.handlePromise(this.updateStyles());
        }), atom.styles.onDidRemoveStyleElement(() => {
            util_1.handlePromise(this.updateStyles());
        }), atom.styles.onDidUpdateStyleElement(() => {
            util_1.handlePromise(this.updateStyles());
        }));
        this.initPromise = new Promise((resolve) => {
            this._element.addEventListener('dom-ready', () => {
                if (this.destroyed)
                    return;
                this._element.setZoomLevel(this.zoomLevel);
                resolve();
                util_1.handlePromise(this.updateStyles().then(init));
            });
        });
    }
    get element() {
        return this._element;
    }
    async runJS(js) {
        return new Promise((resolve) => this._element.executeJavaScript(js, false, resolve));
    }
    destroy() {
        if (this.destroyed)
            return;
        this.destroyed = true;
        this.disposables.dispose();
        this._element.remove();
    }
    async update(html, renderLaTeX) {
        if (this.destroyed)
            return undefined;
        return this.runRequest('update-preview', {
            html,
            renderLaTeX,
        });
    }
    async setSourceMap(map) {
        return this.send('set-source-map', { map });
    }
    async setBasePath(path) {
        return this.send('set-base-path', { path });
    }
    async init(params) {
        return this.send('init', params);
    }
    async updateImages(oldSource, version) {
        return this.send('update-images', {
            oldsrc: oldSource,
            v: version,
        });
    }
    async printToPDF(opts) {
        return new Promise((resolve, reject) => {
            this._element.getWebContents().printToPDF(opts, (error, data) => {
                if (error) {
                    reject(error);
                    return;
                }
                resolve(data);
            });
        });
    }
    async sync(line, flash) {
        return this.send('sync', { line, flash });
    }
    async syncSource() {
        return this.runRequest('sync-source', {});
    }
    async scrollSync(firstLine, lastLine) {
        return this.send('scroll-sync', { firstLine, lastLine });
    }
    zoomIn() {
        this.zoomLevel += 0.1;
        this._element.setZoomLevel(this.zoomLevel);
    }
    zoomOut() {
        this.zoomLevel -= 0.1;
        this._element.setZoomLevel(this.zoomLevel);
    }
    resetZoom() {
        this.zoomLevel = 0;
        this._element.setZoomLevel(this.zoomLevel);
    }
    print() {
        this._element.print();
    }
    openDevTools() {
        this._element.openDevTools();
    }
    async reload() {
        await this.runRequest('reload', {});
        this._element.reload();
    }
    async error(msg) {
        return this.send('error', { msg });
    }
    async getTeXConfig() {
        return this.runRequest('get-tex-config', {});
    }
    async getSelection() {
        return this.runRequest('get-selection', {});
    }
    async updateStyles() {
        return this.send('style', { styles: util_2.getPreviewStyles(true) });
    }
    async runRequest(request, args) {
        const id = this.replyCallbackId++;
        const result = new Promise((resolve) => {
            this.replyCallbacks.set(id, {
                request: request,
                callback: (result) => {
                    this.replyCallbacks.delete(id);
                    resolve(result);
                },
            });
        });
        const newargs = Object.assign({ id }, args);
        await this.send(request, newargs);
        return result;
    }
    async send(channel, value) {
        await this.initPromise;
        this._element.send(channel, value);
    }
}
exports.WebviewHandler = WebviewHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2Vidmlldy1oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL21hcmtkb3duLXByZXZpZXctdmlldy93ZWJ2aWV3LWhhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBbUQ7QUFDbkQsdUNBQTRDO0FBQzVDLGtEQUFrRDtBQUVsRCxrQ0FBbUQ7QUFFbkQsaUNBQXlDO0FBMkN6QyxNQUFhLGNBQWM7SUFlekIsWUFBWSxJQUFnQztRQWQ1QixZQUFPLEdBQUcsSUFBSSxjQUFPLEVBS2xDLENBQUE7UUFDTyxnQkFBVyxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUV6QyxjQUFTLEdBQUcsS0FBSyxDQUFBO1FBQ2pCLGNBQVMsR0FBRyxDQUFDLENBQUE7UUFDYixtQkFBYyxHQUFHLElBQUksR0FBRyxFQUErQixDQUFBO1FBQ3ZELG9CQUFlLEdBQUcsQ0FBQyxDQUFBO1FBSXpCLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQTtRQUNqRCxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsdUJBQXVCLEVBQUUscUJBQXFCLENBQUMsQ0FBQTtRQUMzRSxJQUFJLENBQUMsUUFBUSxDQUFDLGtCQUFrQixHQUFHLE1BQU0sQ0FBQTtRQUN6QyxJQUFJLENBQUMsUUFBUSxDQUFDLGVBQWUsR0FBRyxNQUFNLENBQUE7UUFDdEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEdBQUcsV0FBVyxTQUFTLDZCQUE2QixDQUFBO1FBQ3JFLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUE7UUFDbEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQTtRQUNuQyxJQUFJLENBQUMsUUFBUSxDQUFDLGdCQUFnQixDQUM1QixhQUFhLEVBQ2IsQ0FBQyxDQUFpQyxFQUFF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Q0FBQyxDQUFBO29CQUM5QixPQUFPLENBQUMsTUFBTSxDQUFDLENBQUE7Z0JBQ2pCLENBQUM7YUFDb0MsQ0FBQyxDQUFBO1FBQzFDLENBQUMsQ0FBQyxDQUFBO1FBQ0YsTUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFBO1FBQzNDLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBSSxPQUFPLEVBQUUsT0FBd0IsQ0FBQyxDQUFBO1FBQ3JELE9BQU8sTUFBTSxDQUFBO0lBQ2YsQ0FBQztJQUVTLEtBQUssQ0FBQyxJQUFJLENBQ2xCLE9BQVUsRUFDVixLQUFvQjtRQUVwQixNQUFNLElBQUksQ0FBQyxXQUFXLENBQUE7UUFDdEIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUksT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFBO0lBQ3ZDLENBQUM7Q0FDRjtBQWpQRCx3Q0FpUEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFbWl0dGVyLCBDb21wb3NpdGVEaXNwb3NhYmxlIH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IFdlYnZpZXdUYWcsIHNoZWxsIH0gZnJvbSAnZWxlY3Ryb24nXG5pbXBvcnQgZmlsZVVyaVRvUGF0aCA9IHJlcXVpcmUoJ2ZpbGUtdXJpLXRvLXBhdGgnKVxuXG5pbXBvcnQgeyBoYW5kbGVQcm9taXNlLCBhdG9tQ29uZmlnIH0gZnJvbSAnLi4vdXRpbCdcbmltcG9ydCB7IFJlcXVlc3RSZXBseU1hcCwgQ2hhbm5lbE1hcCB9IGZyb20gJy4uLy4uL3NyYy1jbGllbnQvaXBjJ1xuaW1wb3J0IHsgZ2V0UHJldmlld1N0eWxlcyB9IGZyb20gJy4vdXRpbCdcblxuZXhwb3J0IHR5cGUgUmVwbHlDYWxsYmFja1N0cnVjdDxcbiAgVCBleHRlbmRzIGtleW9mIFJlcXVlc3RSZXBseU1hcCA9IGtleW9mIFJlcXVlc3RSZXBseU1hcFxuPiA9IHtcbiAgW0sgaW4ga2V5b2YgUmVxdWVzdFJlcGx5TWFwXToge1xuICAgIHJlcXVlc3Q6IEtcbiAgICBjYWxsYmFjazogKHJlcGx5OiBSZXF1ZXN0UmVwbHlNYXBbS10pID0+IHZvaWRcbiAgfVxufVtUXVxuXG5pbnRlcmZhY2UgUHJpbnRUb1BERk9wdGlvbnNSZWFsIHtcbiAgLyoqXG4gICAqIFNwZWNpZmllcyB0aGUgdHlwZSBvZiBtYXJnaW5zIHRvIHVzZS4gVXNlcyAwIGZvciBkZWZhdWx0IG1hcmdpbiwgMSBmb3Igbm9cbiAgICogbWFyZ2luLCBhbmQgMiBmb3IgbWluaW11bSBtYXJnaW4uXG4gICAqL1xuICBtYXJnaW5zVHlwZT86IG51bWJlclxuICAvKipcbiAgICogU3BlY2lmeSBwYWdlIHNpemUgb2YgdGhlIGdlbmVyYXRlZCBQREYuIENhbiBiZSBBMywgQTQsIEE1LCBMZWdhbCwgTGV0dGVyLFxuICAgKiBUYWJsb2lkIG9yIGFuIE9iamVjdCBjb250YWluaW5nIGhlaWdodCBhbmQgd2lkdGggaW4gbWljcm9ucy5cbiAgICovXG4gIHBhZ2VTaXplPzpcbiAgICB8IHsgd2lkdGg6IG51bWJlcjsgaGVpZ2h0OiBudW1iZXIgfVxuICAgIHwgJ0EzJ1xuICAgIHwgJ0E0J1xuICAgIHwgJ0E1J1xuICAgIHwgJ0xlZ2FsJ1xuICAgIHwgJ0xldHRlcidcbiAgICB8ICdUYWJsb2lkJ1xuICAvKipcbiAgICogV2hldGhlciB0byBwcmludCBDU1MgYmFja2dyb3VuZHMuXG4gICAqL1xuICBwcmludEJhY2tncm91bmQ/OiBib29sZWFuXG4gIC8qKlxuICAgKiBXaGV0aGVyIHRvIHByaW50IHNlbGVjdGlvbiBvbmx5LlxuICAgKi9cbiAgcHJpbnRTZWxlY3Rpb25Pbmx5PzogYm9vbGVhblxuICAvKipcbiAgICogdHJ1ZSBmb3IgbGFuZHNjYXBlLCBmYWxzZSBmb3IgcG9ydHJhaXQuXG4gICAqL1xuICBsYW5kc2NhcGU/OiBib29sZWFuXG59XG5cbmV4cG9ydCBjbGFzcyBXZWJ2aWV3SGFuZGxlciB7XG4gIHB1YmxpYyByZWFkb25seSBlbWl0dGVyID0gbmV3IEVtaXR0ZXI8XG4gICAge30sXG4gICAge1xuICAgICAgJ2RpZC1zY3JvbGwtcHJldmlldyc6IHsgbWluOiBudW1iZXI7IG1heDogbnVtYmVyIH1cbiAgICB9XG4gID4oKVxuICBwcm90ZWN0ZWQgZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gIHByaXZhdGUgcmVhZG9ubHkgX2VsZW1lbnQ6IFdlYnZpZXdUYWdcbiAgcHJpdmF0ZSBkZXN0cm95ZWQgPSBmYWxzZVxuICBwcml2YXRlIHpvb21MZXZlbCA9IDBcbiAgcHJpdmF0ZSByZXBseUNhbGxiYWNrcyA9IG5ldyBNYXA8bnVtYmVyLCBSZXBseUNhbGxiYWNrU3RydWN0PigpXG4gIHByaXZhdGUgcmVwbHlDYWxsYmFja0lkID0gMFxuICBwcml2YXRlIHJlYWRvbmx5IGluaXRQcm9taXNlOiBQcm9taXNlPHZvaWQ+XG5cbiAgY29uc3RydWN0b3IoaW5pdDogKCkgPT4gdm9pZCB8IFByb21pc2U8dm9pZD4pIHtcbiAgICB0aGlzLl9lbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnd2VidmlldycpXG4gICAgdGhpcy5fZWxlbWVudC5jbGFzc0xpc3QuYWRkKCdtYXJrZG93bi1wcmV2aWV3LXBsdXMnLCAnbmF0aXZlLWtleS1iaW5kaW5ncycpXG4gICAgdGhpcy5fZWxlbWVudC5kaXNhYmxld2Vic2VjdXJpdHkgPSAndHJ1ZSdcbiAgICB0aGlzLl9lbGVtZW50Lm5vZGVpbnRlZ3JhdGlvbiA9ICd0cnVlJ1xuICAgIHRoaXMuX2VsZW1lbnQuc3JjID0gYGZpbGU6Ly8vJHtfX2Rpcm5hbWV9Ly4uLy4uL2NsaWVudC90ZW1wbGF0ZS5odG1sYFxuICAgIHRoaXMuX2VsZW1lbnQuc3R5bGUud2lkdGggPSAnMTAwJSdcbiAgICB0aGlzLl9lbGVtZW50LnN0eWxlLmhlaWdodCA9ICcxMDAlJ1xuICAgIHRoaXMuX2VsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcbiAgICAgICdpcGMtbWVzc2FnZScsXG4gICAgICAoZTogRWxlY3Ryb24uSXBjTWVzc2FnZUV2ZW50Q3VzdG9tKSA9PiB7XG4gICAgICAgIHN3aXRjaCAoZS5jaGFubmVsKSB7XG4gICAgICAgICAgY2FzZSAnem9vbS1pbic6XG4gICAgICAgICAgICB0aGlzLnpvb21JbigpXG4gICAgICAgICAgICBicmVha1xuICAgICAgICAgIGNhc2UgJ3pvb20tb3V0JzpcbiAgICAgICAgICAgIHRoaXMuem9vbU91dCgpXG4gICAgICAgICAgICBicmVha1xuICAgICAgICAgIGNhc2UgJ2RpZC1zY3JvbGwtcHJldmlldyc6XG4gICAgICAgICAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZGlkLXNjcm9sbC1wcmV2aWV3JywgZS5hcmdzWzBdKVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICBjYXNlICd1bmNhdWdodC1lcnJvcic6IHtcbiAgICAgICAgICAgIGNvbnN0IGVyciA9IGUuYXJnc1swXVxuICAgICAgICAgICAgY29uc3QgbmV3RXJyID0gbmV3IEVycm9yKClcbiAgICAgICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRGYXRhbEVycm9yKFxuICAgICAgICAgICAgICBgVW5jYXVnaHQgZXJyb3IgJHtlcnIubmFtZX0gaW4gbWFya2Rvd24tcHJldmlldy1wbHVzIHdlYnZpZXcgY2xpZW50YCxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGRpc21pc3NhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgIHN0YWNrOiBuZXdFcnIuc3RhY2ssXG4gICAgICAgICAgICAgICAgZGV0YWlsOiBgJHtlcnIubWVzc2FnZX1cXG5cXG5zdGFjazpcXG4ke2Vyci5zdGFja31gLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICB9XG4gICAgICAgICAgY2FzZSAnc2hvdy1jb250ZXh0LW1lbnUnOiB7XG4gICAgICAgICAgICBhdG9tLmNvbnRleHRNZW51LnNob3dGb3JFdmVudCh7IHRhcmdldDogdGhpcy5fZWxlbWVudCB9KVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICB9XG4gICAgICAgICAgLy8gcmVwbGllc1xuICAgICAgICAgIGNhc2UgJ3JlcXVlc3QtcmVwbHknOiB7XG4gICAgICAgICAgICBjb25zdCB7IGlkLCByZXF1ZXN0LCByZXN1bHQgfSA9IGUuYXJnc1swXVxuICAgICAgICAgICAgY29uc3QgY2IgPSB0aGlzLnJlcGx5Q2FsbGJhY2tzLmdldChpZClcbiAgICAgICAgICAgIGlmIChjYiAmJiByZXF1ZXN0ID09PSBjYi5yZXF1ZXN0KSB7XG4gICAgICAgICAgICAgIGNvbnN0IGNhbGxiYWNrOiAocjogYW55KSA9PiB2b2lkID0gY2IuY2FsbGJhY2tcbiAgICAgICAgICAgICAgY2FsbGJhY2socmVzdWx0KVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgKVxuICAgIHRoaXMuX2VsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignd2lsbC1uYXZpZ2F0ZScsIGFzeW5jIChlKSA9PiB7XG4gICAgICBjb25zdCBleHRzID0gYXRvbUNvbmZpZygpLnByZXZpZXdDb25maWcuc2hlbGxPcGVuRmlsZUV4dGVuc2lvbnNcbiAgICAgIGNvbnN0IGZvcmNlT3BlbkV4dGVybmFsID0gZXh0cy5zb21lKChleHQpID0+XG4gICAgICAgIGUudXJsLnRvTG93ZXJDYXNlKCkuZW5kc1dpdGgoYC4ke2V4dC50b0xvd2VyQ2FzZSgpfWApLFxuICAgICAgKVxuICAgICAgaWYgKGUudXJsLnN0YXJ0c1dpdGgoJ2ZpbGU6Ly8nKSAmJiAhZm9yY2VPcGVuRXh0ZXJuYWwpIHtcbiAgICAgICAgaGFuZGxlUHJvbWlzZShhdG9tLndvcmtzcGFjZS5vcGVuKGZpbGVVcmlUb1BhdGgoZS51cmwpKSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHNoZWxsLm9wZW5FeHRlcm5hbChlLnVybClcbiAgICAgIH1cbiAgICB9KVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoXG4gICAgICBhdG9tLnN0eWxlcy5vbkRpZEFkZFN0eWxlRWxlbWVudCgoKSA9PiB7XG4gICAgICAgIGhhbmRsZVByb21pc2UodGhpcy51cGRhdGVTdHlsZXMoKSlcbiAgICAgIH0pLFxuICAgICAgYXRvbS5zdHlsZXMub25EaWRSZW1vdmVTdHlsZUVsZW1lbnQoKCkgPT4ge1xuICAgICAgICBoYW5kbGVQcm9taXNlKHRoaXMudXBkYXRlU3R5bGVzKCkpXG4gICAgICB9KSxcbiAgICAgIGF0b20uc3R5bGVzLm9uRGlkVXBkYXRlU3R5bGVFbGVtZW50KCgpID0+IHtcbiAgICAgICAgaGFuZGxlUHJvbWlzZSh0aGlzLnVwZGF0ZVN0eWxlcygpKVxuICAgICAgfSksXG4gICAgKVxuXG4gICAgdGhpcy5pbml0UHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICB0aGlzLl9lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2RvbS1yZWFkeScsICgpID0+IHtcbiAgICAgICAgaWYgKHRoaXMuZGVzdHJveWVkKSByZXR1cm5cbiAgICAgICAgdGhpcy5fZWxlbWVudC5zZXRab29tTGV2ZWwodGhpcy56b29tTGV2ZWwpXG4gICAgICAgIHJlc29sdmUoKVxuICAgICAgICBoYW5kbGVQcm9taXNlKHRoaXMudXBkYXRlU3R5bGVzKCkudGhlbihpbml0KSlcbiAgICAgIH0pXG4gICAgfSlcbiAgfVxuXG4gIHB1YmxpYyBnZXQgZWxlbWVudCgpOiBIVE1MRWxlbWVudCB7XG4gICAgcmV0dXJuIHRoaXMuX2VsZW1lbnRcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBydW5KUzxUPihqczogc3RyaW5nKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPFQ+KChyZXNvbHZlKSA9PlxuICAgICAgdGhpcy5fZWxlbWVudC5leGVjdXRlSmF2YVNjcmlwdChqcywgZmFsc2UsIHJlc29sdmUpLFxuICAgIClcbiAgfVxuXG4gIHB1YmxpYyBkZXN0cm95KCkge1xuICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuXG4gICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKClcbiAgICB0aGlzLl9lbGVtZW50LnJlbW92ZSgpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdXBkYXRlKGh0bWw6IHN0cmluZywgcmVuZGVyTGFUZVg6IGJvb2xlYW4pIHtcbiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybiB1bmRlZmluZWRcbiAgICByZXR1cm4gdGhpcy5ydW5SZXF1ZXN0KCd1cGRhdGUtcHJldmlldycsIHtcbiAgICAgIGh0bWwsXG4gICAgICByZW5kZXJMYVRlWCxcbiAgICB9KVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHNldFNvdXJjZU1hcChtYXA6IHtcbiAgICBbbGluZTogbnVtYmVyXTogeyB0YWc6IHN0cmluZzsgaW5kZXg6IG51bWJlciB9W11cbiAgfSkge1xuICAgIHJldHVybiB0aGlzLnNlbmQ8J3NldC1zb3VyY2UtbWFwJz4oJ3NldC1zb3VyY2UtbWFwJywgeyBtYXAgfSlcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzZXRCYXNlUGF0aChwYXRoPzogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMuc2VuZDwnc2V0LWJhc2UtcGF0aCc+KCdzZXQtYmFzZS1wYXRoJywgeyBwYXRoIH0pXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgaW5pdChwYXJhbXM6IENoYW5uZWxNYXBbJ2luaXQnXSkge1xuICAgIHJldHVybiB0aGlzLnNlbmQ8J2luaXQnPignaW5pdCcsIHBhcmFtcylcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB1cGRhdGVJbWFnZXMob2xkU291cmNlOiBzdHJpbmcsIHZlcnNpb246IG51bWJlciB8IHVuZGVmaW5lZCkge1xuICAgIHJldHVybiB0aGlzLnNlbmQ8J3VwZGF0ZS1pbWFnZXMnPigndXBkYXRlLWltYWdlcycsIHtcbiAgICAgIG9sZHNyYzogb2xkU291cmNlLFxuICAgICAgdjogdmVyc2lvbixcbiAgICB9KVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHByaW50VG9QREYob3B0czogUHJpbnRUb1BERk9wdGlvbnNSZWFsKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPEJ1ZmZlcj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgLy8gVE9ETzogQ29tcGxhaW4gb24gRWxlY3Ryb25cbiAgICAgIHRoaXMuX2VsZW1lbnQuZ2V0V2ViQ29udGVudHMoKS5wcmludFRvUERGKG9wdHMgYXMgYW55LCAoZXJyb3IsIGRhdGEpID0+IHtcbiAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgcmVqZWN0KGVycm9yKVxuICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG4gICAgICAgIHJlc29sdmUoZGF0YSlcbiAgICAgIH0pXG4gICAgfSlcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzeW5jKGxpbmU6IG51bWJlciwgZmxhc2g6IGJvb2xlYW4pIHtcbiAgICByZXR1cm4gdGhpcy5zZW5kPCdzeW5jJz4oJ3N5bmMnLCB7IGxpbmUsIGZsYXNoIH0pXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc3luY1NvdXJjZSgpIHtcbiAgICByZXR1cm4gdGhpcy5ydW5SZXF1ZXN0KCdzeW5jLXNvdXJjZScsIHt9KVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHNjcm9sbFN5bmMoZmlyc3RMaW5lOiBudW1iZXIsIGxhc3RMaW5lOiBudW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy5zZW5kPCdzY3JvbGwtc3luYyc+KCdzY3JvbGwtc3luYycsIHsgZmlyc3RMaW5lLCBsYXN0TGluZSB9KVxuICB9XG5cbiAgcHVibGljIHpvb21JbigpIHtcbiAgICB0aGlzLnpvb21MZXZlbCArPSAwLjFcbiAgICB0aGlzLl9lbGVtZW50LnNldFpvb21MZXZlbCh0aGlzLnpvb21MZXZlbClcbiAgfVxuXG4gIHB1YmxpYyB6b29tT3V0KCkge1xuICAgIHRoaXMuem9vbUxldmVsIC09IDAuMVxuICAgIHRoaXMuX2VsZW1lbnQuc2V0Wm9vbUxldmVsKHRoaXMuem9vbUxldmVsKVxuICB9XG5cbiAgcHVibGljIHJlc2V0Wm9vbSgpIHtcbiAgICB0aGlzLnpvb21MZXZlbCA9IDBcbiAgICB0aGlzLl9lbGVtZW50LnNldFpvb21MZXZlbCh0aGlzLnpvb21MZXZlbClcbiAgfVxuXG4gIHB1YmxpYyBwcmludCgpIHtcbiAgICB0aGlzLl9lbGVtZW50LnByaW50KClcbiAgfVxuXG4gIHB1YmxpYyBvcGVuRGV2VG9vbHMoKSB7XG4gICAgdGhpcy5fZWxlbWVudC5vcGVuRGV2VG9vbHMoKVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlbG9hZCgpIHtcbiAgICBhd2FpdCB0aGlzLnJ1blJlcXVlc3QoJ3JlbG9hZCcsIHt9KVxuICAgIHRoaXMuX2VsZW1lbnQucmVsb2FkKClcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBlcnJvcihtc2c6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLnNlbmQ8J2Vycm9yJz4oJ2Vycm9yJywgeyBtc2cgfSlcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRUZVhDb25maWcoKSB7XG4gICAgcmV0dXJuIHRoaXMucnVuUmVxdWVzdCgnZ2V0LXRleC1jb25maWcnLCB7fSlcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRTZWxlY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMucnVuUmVxdWVzdCgnZ2V0LXNlbGVjdGlvbicsIHt9KVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHVwZGF0ZVN0eWxlcygpIHtcbiAgICByZXR1cm4gdGhpcy5zZW5kPCdzdHlsZSc+KCdzdHlsZScsIHsgc3R5bGVzOiBnZXRQcmV2aWV3U3R5bGVzKHRydWUpIH0pXG4gIH1cblxuICBwcm90ZWN0ZWQgYXN5bmMgcnVuUmVxdWVzdDxUIGV4dGVuZHMga2V5b2YgUmVxdWVzdFJlcGx5TWFwPihcbiAgICByZXF1ZXN0OiBULFxuICAgIGFyZ3M6IHsgW0sgaW4gRXhjbHVkZTxrZXlvZiBDaGFubmVsTWFwW1RdLCAnaWQnPl06IENoYW5uZWxNYXBbVF1bS10gfSxcbiAgKSB7XG4gICAgY29uc3QgaWQgPSB0aGlzLnJlcGx5Q2FsbGJhY2tJZCsrXG4gICAgY29uc3QgcmVzdWx0ID0gbmV3IFByb21pc2U8UmVxdWVzdFJlcGx5TWFwW1RdPigocmVzb2x2ZSkgPT4ge1xuICAgICAgdGhpcy5yZXBseUNhbGxiYWNrcy5zZXQoaWQsICh7XG4gICAgICAgIHJlcXVlc3Q6IHJlcXVlc3QsXG4gICAgICAgIGNhbGxiYWNrOiAocmVzdWx0OiBSZXF1ZXN0UmVwbHlNYXBbVF0pID0+IHtcbiAgICAgICAgICB0aGlzLnJlcGx5Q2FsbGJhY2tzLmRlbGV0ZShpZClcbiAgICAgICAgICByZXNvbHZlKHJlc3VsdClcbiAgICAgICAgfSxcbiAgICAgIH0gYXMgdW5rbm93bikgYXMgUmVwbHlDYWxsYmFja1N0cnVjdDxUPilcbiAgICB9KVxuICAgIGNvbnN0IG5ld2FyZ3MgPSBPYmplY3QuYXNzaWduKHsgaWQgfSwgYXJncylcbiAgICBhd2FpdCB0aGlzLnNlbmQ8VD4ocmVxdWVzdCwgbmV3YXJncyBhcyBDaGFubmVsTWFwW1RdKVxuICAgIHJldHVybiByZXN1bHRcbiAgfVxuXG4gIHByb3RlY3RlZCBhc3luYyBzZW5kPFQgZXh0ZW5kcyBrZXlvZiBDaGFubmVsTWFwPihcbiAgICBjaGFubmVsOiBULFxuICAgIHZhbHVlOiBDaGFubmVsTWFwW1RdLFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLmluaXRQcm9taXNlXG4gICAgdGhpcy5fZWxlbWVudC5zZW5kPFQ+KGNoYW5uZWwsIHZhbHVlKVxuICB9XG59XG4iXX0=